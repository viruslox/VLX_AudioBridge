# VLX_AudioBridge

**VLX_AudioBridge** (formerly Ermete) is a bi-directional audio gateway designed for Linux servers. It bridges the gap between Discord voice channels, web-based overlays, and streaming protocols (SRT).
It allows you to inject audio from web sources (overlays) into Discord and simultaneously extract, mix, and stream Discord voice chat to an external media server via SRT.

### NOTE: 
The idea, the logics, the architecture, reviews, validation are made in VirusLox, but the code is 95% generated by Gemini.
Please check TODO file to keep track of what we still missing...todo

## Architecture

The bridge operates in two concurrent directions:

1.  **Ingress (Overlay -> Discord):**
    * Spawns headless **Chromium** instances for configured overlay URLs.
    * Routes browser audio to a dedicated **Pipewire Virtual Sink**.
    * Captures audio via **PortAudio**, encodes it to Opus, and streams it to the Discord voice channel.

2.  **Egress (Discord -> SRT Stream):**
    * Captures incoming Opus packets from Discord users.
    * **Mixes** audio streams in real-time, handling multiple speakers.
    * Filters out specific users (e.g., the bot itself or admin accounts) based on configuration.
    * Pipes the mixed PCM audio to **FFmpeg** for AAC encoding and **SRT** transmission (e.g., to MediaMTX).

### Structure
```bash
VLX_AudioBridge/
├── main.go              # Entry point: inizializza config, bot, pipewire check e goroutines
├── AudioBridge.yaml              # (Nuovo) Configurazione centralizzata
├── internal/
│   ├── config/
│   │   └── config.go            # Parser YAML per caricare la configurazione
│   ├── bot/
│   │   └── bot.go               # Gestione sessione Discord, comandi join/leave/shutdown
│   ├── stream/                  # [Discord -> SRT]
│   │   ├── packet_handler.go    # Riceve pacchetti Opus, filtra utenti (SSRC), gestisce buffer
│   │   ├── mixer.go             # Decodifica Opus in PCM e mixa matematicamente le tracce
│   │   └── ffmpeg_srt.go        # Gestisce il processo FFmpeg e scrive nella sua Pipe (stdin)
│   ├── overlay/                 # [Overlay -> Discord]
│   │   ├── browser_manager.go   # Lancia/Chiude istanze Chromium headless con ENV per Pipewire
│   │   └── audio_capture.go     # (Ex input.go) Legge da Pipewire (Virtual Sink Monitor) via PortAudio
│   └── system/
│       └── pipewire.go          # Helper per verificare/creare il Virtual Sink (pactl/pw-cli)
├── scripts/
│   └── ermete.service           # File di unità Systemd per l'autostart
├── go.mod                       # Dipendenze Go
├── go.sum                       # Checksum dipendenze
└── README.md
```

## System Requirements
* **OS:** Linux (Tested on Debian).
* **Audio System:** Pipewire (with PulseAudio compatibility layer `pipewire-pulse`).
* **Dependencies:**
    * Go 1.20+
    * GCC (required for CGO)
    * FFmpeg
    * Chromium Browser
    * PortAudio & Opus development libraries

### Install Dependencies
```bash
sudo apt update
sudo apt install git golang ffmpeg chromium-browser portaudio19-dev libopus-dev libopusfile-dev
```

## Installation & Build
### Clone the repository:
```bash
mkdir -p ~/go/src/ && cd ~/go/src/
git clone [https://github.com/viruslox/VLX_AudioBridge.git](https://github.com/viruslox/VLX_AudioBridge.git)
cd VLX_AudioBridge
```
### Initialize and Tidy Modules:
```bash
go mod init
go mod tidy
```

### Build the Binary:
```bash
go build -o vlx_audiobridge main.go
```

### Deploy to /opt 
I hate "sudo", but let's make it easy:
```bash
sudo mkdir -p /opt/VLX_AudioBridge
# Ensure your user owns the directory
sudo chown -R $USER:$USER /opt/VLX_AudioBridge
cp ~/go/src/VLX_AudioBridge/vlx_audiobridge /opt/VLX_AudioBridge/
# Copy config the example, but remember to edit it
cp ~/go/src/VLX_AudioBridge/AudioBridge.yaml /opt/VLX_AudioBridge/
```

## Configuration
The application uses a YAML configuration file. Edit AudioBridge.yaml. Example:
```YAML
discord:
  token: "YOUR_DISCORD_BOT_TOKEN"
  prefix: "vlx."       # Command prefix
  guild_id: ""         # Optional: Restrict to specific Guild ID

streaming:
  # SRT Destination (e.g., MediaMTX)
  destination_url: "srt://127.0.0.1:8890?streamid=publish:vlx_audio&mode=caller"
  bitrate: "128k"
  # List of Discord User IDs to exclude from the SRT stream (Max 2)
  excluded_users:
    - "123456789012345678"

overlays:
  # List of Web Overlay URLs to load and inject into Discord (Max 3)
  urls:
    - "[https://stream-elements.com/overlay/](https://stream-elements.com/overlay/)..."
    - "[https://another-overlay.com/](https://another-overlay.com/)..."
```

## Usage
### Manual Run
Ensure your Pipewire session is active (usually strictly related to the user session).

```Bash
./vlx_bridge
```

## Discord Commands

vlx.join : Joins the user's voice channel, starts the SRT stream, and launches overlay browsers.
vlx.leave: Stops streaming, closes browsers, and disconnects from the voice channel.
vlx.shutdown: Gracefully shuts down the entire bridge process (Admin only).

## Running as a Service (Systemd)
Since Pipewire is a user-level service, VLX_AudioBridge must run as a Systemd User Service, not a system-wide root service.
Create the service file: ~/.config/systemd/user/vlx_audiobridge.service

```Ini, TOML
[Unit]
Description=VLX AudioBridge Service
After=network.target sound.target pipewire.service
Requires=pipewire.service

[Service]
Type=simple
# Adjust paths to your actual installation
ExecStart=/opt/VLX_AudioBridge/vlx_audiobridge
WorkingDirectory=/opt/VLX_AudioBridge/
Restart=always
RestartSec=5
# Ensure XDG_RUNTIME_DIR is set for Pipewire access
Environment=XDG_RUNTIME_DIR=/run/user/%U

[Install]
WantedBy=default.target
```

### Enable and Start:

```Bash
systemctl --user daemon-reload
systemctl --user enable vlx_bridge
systemctl --user start vlx_bridge
```

## Check Logs:

```bash
journalctl --user -u vlx_bridge -f
```

## Troubleshooting

"Virtual Sink not found": Ensure pipewire-pulse is running. The application attempts to create VLX_VirtualSink automatically using pactl.
Chromium Audio Issues: Check if the PULSE_SINK environment variable is correctly respected by your Chromium version.
FFmpeg Errors: Ensure FFmpeg is installed and accessible in the system $PATH.
Opus/CGO Errors: Ensure libopus-dev and portaudio19-dev are installed.

## License
This project is licensed under the GNU General Public License v3.0. See the LICENSE file for details.
